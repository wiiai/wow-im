import{d as y,a as x,b as a,u as C,aA as R,aB as g,o as S,g as D,h as T,i as _,_ as h,j as b,y as I,x as A}from"./index.504df769.js";import{T as L}from"./index.dabf947d.js";function B(i,c,s){return navigator.mediaDevices.getUserMedia(i).then(c).catch(s)}function M(){return!!navigator.mediaDevices.getUserMedia}const F={iceServers:[{urls:["stun:ss-turn1.xirsys.com"]},{username:"CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",credential:"446118be-38a4-11eb-9ece-0242ac140004",urls:["turn:ss-turn1.xirsys.com:80?transport=udp","turn:ss-turn1.xirsys.com:3478?transport=udp"]}]};let v=null;const U=(i,c)=>{const{userInfo:s,onGetLocalStream:p,onRemoteTrack:d}=c,n={};window.pc=n;function f(){}function l(e,o){console.log("initCall",e,o);const t=new RTCPeerConnection(F);n[e]=t,v.getTracks().forEach(r=>{n[e].addTrack(r,v)});const k=async()=>{console.log("onnegotiationneeded");const r=await n[e].createOffer();console.log("setLocalDescription"),await n[e].setLocalDescription(r),console.log("send sdp"),i.emit("sdp",{type:"video-offer",description:n[e].localDescription,to:e,sender:s.id})};o&&(n[e].onnegotiationneeded=k),n[e].ontrack=r=>{let w=r.streams[0];d==null||d(w)},n[e].onicecandidate=({candidate:r})=>{console.log("onicecandidate"),i.emit("ice candidates",{candidate:r,to:e,sender:s.id})}}function u(e,o){M()?B(o,function(t){v=t,p(t),e&&e()},function(t){console.log("\u8BBF\u95EE\u7528\u6237\u5A92\u4F53\u8BBE\u5907\u5931\u8D25\uFF1A",t.name,t.message)}):alert("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u517C\u5BB9")}return i.on("ice candidates",e=>{if(console.log("ice candidate: ",e),console.log("pc[data.sender]",n[e.sender]),e.candidate){var o=new RTCIceCandidate(e.candidate);n[e.sender].addIceCandidate(o).catch()}}),i.on("sdp",e=>{console.log("receive sdp ",e),e.description.type==="offer"?u(()=>{l(e.sender,!1);let o=new RTCSessionDescription(e.description);n[e.sender].setRemoteDescription(o).then(()=>{n[e.sender].createAnswer().then(t=>n[e.sender].setLocalDescription(t)).then(()=>{i.emit("sdp",{type:"video-answer",description:n[e.sender].localDescription,to:e.sender,sender:s.id})}).catch()})}):e.description.type==="answer"&&n[e.sender].setRemoteDescription(new RTCSessionDescription(e.description))}),{initCall:l,initLocal:u,close:e=>{var o;(o=n[e])==null||o.close()},addTrack:f}},V={class:"main"},E=y({__name:"index",setup(i){var u,m,e;const c=x(),s=a(null);C();const p=R().query;a([]);const{initCall:d,initLocal:n}=U(g,{userInfo:{id:(u=c.userInfo)==null?void 0:u.id,avatar:(m=c.userInfo)==null?void 0:m.avatar,nickname:(e=c.userInfo)==null?void 0:e.nickname},onRemoteTrack:o=>{console.log("onRemoteTrack"),s.value&&(s.value.srcObject=o)},onGetLocalStream:o=>{}});a(!1),a(!1),a(!1);const f=()=>{},l=()=>{};return S(()=>{g.emit("enter-meeting",{meeting_id:p.id}),g.on("enter-meeting",o=>{console.log("enter-meeting",o),n(()=>{d(o.user_id,!0)},{video:!0,audio:!0})})}),(o,t)=>(D(),T("div",V,[_("div",{onClick:f},"\u4F7F\u7528\u97F3\u9891"),_("div",{onClick:l},"\u4F7F\u7528\u89C6\u9891"),_("div",{onClick:l},"\u5206\u4EAB\u5C4F\u5E55"),_("video",{class:"screen-remote",src:"",ref_key:"videoRef",ref:s,autoplay:""},null,512)]))}});const q=h(E,[["__scopeId","data-v-5d1c7e12"]]),G=y({__name:"index",setup(i){return x(),a(null),C(),(c,s)=>(D(),b(L,null,{main:I(()=>[A(q)]),_:1}))}});const X=h(G,[["__scopeId","data-v-9b1ab44e"]]);export{X as default};
