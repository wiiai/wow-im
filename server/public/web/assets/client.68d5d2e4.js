import{d as w,b as y,a as D,aB as C,u as h,h as R,i as m,g as S,aA as v,_ as k}from"./index.9e2263c7.js";function I(i,r,s){return navigator.mediaDevices.getDisplayMedia(i).then(r).catch(s)}function b(){return!!(navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}const M={iceServers:[{urls:["stun:ss-turn1.xirsys.com"]},{username:"CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",credential:"446118be-38a4-11eb-9ece-0242ac140004",urls:["turn:ss-turn1.xirsys.com:80?transport=udp","turn:ss-turn1.xirsys.com:3478?transport=udp"]}]};let f=null;const x=(i,r)=>{const{userInfo:s,onGetLocalStream:d,onRemoteTrack:l}=r;console.log("useCall userInfo",s);const n={};window.pc=n;function c(e,o){console.log("initCall",e,o);const t=new RTCPeerConnection(M);n[e]=t,f.getTracks().forEach(a=>{n[e].addTrack(a,f)});const _=async()=>{console.log("onnegotiationneeded");const a=await n[e].createOffer();console.log("setLocalDescription"),await n[e].setLocalDescription(a),console.log("send sdp"),i.emit("sdp",{type:"video-offer",description:n[e].localDescription,to:e,sender:s.id})};o&&(n[e].onnegotiationneeded=_),n[e].ontrack=a=>{let g=a.streams[0];l==null||l(g)},n[e].onicecandidate=({candidate:a})=>{console.log("onicecandidate"),i.emit("ice candidates",{candidate:a,to:e,sender:s.id})}}function u(e){if(f){d(f),e&&e();return}b()?I({video:!0},function(o){f=o,d(o),e&&e()},function(o){console.log("\u8BBF\u95EE\u7528\u6237\u5A92\u4F53\u8BBE\u5907\u5931\u8D25\uFF1A",o.name,o.message)}):alert("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u517C\u5BB9")}return i.on("ice candidates",e=>{if(console.log("ice candidate: ",e),console.log("pc[data.sender]",n[e.sender]),e.candidate){var o=new RTCIceCandidate(e.candidate);n[e.sender].addIceCandidate(o).catch()}}),i.on("sdp",e=>{console.log("receive sdp ",e),e.description.type==="offer"?u(()=>{c(e.sender,!1);let o=new RTCSessionDescription(e.description);n[e.sender].setRemoteDescription(o).then(()=>{n[e.sender].createAnswer().then(t=>n[e.sender].setLocalDescription(t)).then(()=>{i.emit("sdp",{type:"video-answer",description:n[e.sender].localDescription,to:e.sender,sender:s.id})}).catch()})}):e.description.type==="answer"&&n[e.sender].setRemoteDescription(new RTCSessionDescription(e.description))}),{initCall:c,initLocal:u,close:e=>{var o;(o=n[e])==null||o.close()}}},L={class:"main"},T=w({__name:"client",setup(i){const r=y(null),s=D(),d=C();h();const l=()=>{var p,e,o;const{initCall:c,initLocal:u}=x(v,{userInfo:{id:(p=s.userInfo)==null?void 0:p.id,avatar:(e=s.userInfo)==null?void 0:e.avatar,nickname:(o=s.userInfo)==null?void 0:o.nickname},onRemoteTrack:t=>{console.log("onRemoteTrack"),r.value&&(r.value.srcObject=t)},onGetLocalStream:t=>{}});u(()=>{var t;c((t=d.query)==null?void 0:t.id,!0)})},n=()=>{var c;v.emit("enter-screen",{to:(c=d.query)==null?void 0:c.id}),l()};return(c,u)=>(S(),R("div",L,[m("button",{onClick:n},"view"),m("video",{class:"screen-remote",src:"",ref_key:"videoRef",ref:r,autoplay:""},null,512)]))}});const A=k(T,[["__scopeId","data-v-f078bafb"]]);export{A as default};
