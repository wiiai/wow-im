import{d as y,o as x,g,h as w,F as k,l as M,m as R,p as T,i as p,t as L,x as S,y as C,s as U,_ as I,a as A,b as G,u as b,aA as m,j as B}from"./index.71365831.js";import{u as V,T as $}from"./index.6abfe9e1.js";function F(t,i,o){return navigator.mediaDevices.getDisplayMedia(t).then(i).catch(o)}function E(){return!!(navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}const X={iceServers:[{urls:["stun:ss-turn1.xirsys.com"]},{username:"CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",credential:"446118be-38a4-11eb-9ece-0242ac140004",urls:["turn:ss-turn1.xirsys.com:80?transport=udp","turn:ss-turn1.xirsys.com:3478?transport=udp"]}]};let _=null;const q=(t,i)=>{const{userInfo:o,onGetLocalStream:u,onRemoteTrack:a}=i;console.log("useCall userInfo",o);const n={};window.pc=n;function c(e,s){console.log("initCall",e,s);const l=new RTCPeerConnection(X);n[e]=l,_.getTracks().forEach(r=>{n[e].addTrack(r,_)});const h=async()=>{console.log("onnegotiationneeded");const r=await n[e].createOffer();console.log("setLocalDescription"),await n[e].setLocalDescription(r),console.log("send sdp"),t.emit("sdp",{type:"video-offer",description:n[e].localDescription,to:e,sender:o.id})};s&&(n[e].onnegotiationneeded=h),n[e].ontrack=r=>{let D=r.streams[0];a==null||a(D)},n[e].onicecandidate=({candidate:r})=>{console.log("onicecandidate"),t.emit("ice candidates",{candidate:r,to:e,sender:o.id})}}function d(e){if(_){u(_),e&&e();return}E()?F({video:!0},function(s){_=s,u(s),e&&e()},function(s){console.log("\u8BBF\u95EE\u7528\u6237\u5A92\u4F53\u8BBE\u5907\u5931\u8D25\uFF1A",s.name,s.message)}):alert("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u517C\u5BB9")}return t.on("ice candidates",e=>{if(console.log("ice candidate: ",e),console.log("pc[data.sender]",n[e.sender]),e.candidate){var s=new RTCIceCandidate(e.candidate);n[e.sender].addIceCandidate(s).catch()}}),t.on("sdp",e=>{console.log("receive sdp ",e),e.description.type==="offer"?d(()=>{c(e.sender,!1);let s=new RTCSessionDescription(e.description);n[e.sender].setRemoteDescription(s).then(()=>{n[e.sender].createAnswer().then(l=>n[e.sender].setLocalDescription(l)).then(()=>{t.emit("sdp",{type:"video-answer",description:n[e.sender].localDescription,to:e.sender,sender:o.id})}).catch()})}):e.description.type==="answer"&&n[e.sender].setRemoteDescription(new RTCSessionDescription(e.description))}),{initCall:c,initLocal:d,close:e=>{var s;(s=n[e])==null||s.close()}}};function N(t,i,o){return navigator.mediaDevices.getDisplayMedia(t).then(i).catch(o)}function O(){return!!(navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}const H={iceServers:[{urls:["stun:ss-turn1.xirsys.com"]},{username:"CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",credential:"446118be-38a4-11eb-9ece-0242ac140004",urls:["turn:ss-turn1.xirsys.com:80?transport=udp","turn:ss-turn1.xirsys.com:3478?transport=udp"]}]};let v=null;const J=(t,i)=>{const{userInfo:o,onGetLocalStream:u,onRemoteTrack:a}=i;console.log("useCall userInfo",o);const n={};window.pc=n;function c(e,s){console.log("initCall",e,s);const l=new RTCPeerConnection(H);n[e]=l,v.getTracks().forEach(r=>{n[e].addTrack(r,v)});const h=async()=>{console.log("onnegotiationneeded");const r=await n[e].createOffer();console.log("setLocalDescription"),await n[e].setLocalDescription(r),console.log("send sdp"),t.emit("sdp",{type:"video-offer",description:n[e].localDescription,to:e,sender:o.id})};s&&(n[e].onnegotiationneeded=h),n[e].ontrack=r=>{let D=r.streams[0];a==null||a(D)},n[e].onicecandidate=({candidate:r})=>{console.log("onicecandidate"),t.emit("ice candidates",{candidate:r,to:e,sender:o.id})}}function d(e){if(v){u(v),e&&e();return}O()?N({video:!0},function(s){v=s,u(s),e&&e()},function(s){console.log("\u8BBF\u95EE\u7528\u6237\u5A92\u4F53\u8BBE\u5907\u5931\u8D25\uFF1A",s.name,s.message)}):alert("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u517C\u5BB9")}return t.on("ice candidates",e=>{if(console.log("ice candidate: ",e),console.log("pc[data.sender]",n[e.sender]),e.candidate){var s=new RTCIceCandidate(e.candidate);n[e.sender].addIceCandidate(s).catch()}}),t.on("sdp",e=>{console.log("receive sdp ",e),e.description.type==="offer"?d(()=>{c(e.sender,!1);let s=new RTCSessionDescription(e.description);n[e.sender].setRemoteDescription(s).then(()=>{n[e.sender].createAnswer().then(l=>n[e.sender].setLocalDescription(l)).then(()=>{t.emit("sdp",{type:"video-answer",description:n[e.sender].localDescription,to:e.sender,sender:o.id})}).catch()})}):e.description.type==="answer"&&n[e.sender].setRemoteDescription(new RTCSessionDescription(e.description))}),{initCall:c,initLocal:d,close:e=>{var s;(s=n[e])==null||s.close()}}},P={class:"list"},W={class:"item"},z={class:"avatar"},j=["src"],Y={class:"main"},K={class:"name"},Q=y({__name:"index",props:["clickItem"],setup(t){const i=t,o=V();return x(()=>{o.list.length||o.queryFriend()}),(u,a)=>{const n=T("v-btn");return g(),w("div",P,[(g(!0),w(k,null,M(R(o).list,c=>(g(),w("div",W,[p("div",z,[p("img",{src:c.avatar,alt:""},null,8,j)]),p("div",Y,[p("div",K,L(c.nickname),1),S(n,{color:"success",variant:"text",size:"small",class:"share",onClick:d=>i.clickItem(c)},{default:C(()=>[U(" \u684C\u9762\u5171\u4EAB ")]),_:2},1032,["onClick"])])]))),256))])}}});const Z=I(Q,[["__scopeId","data-v-14b52e79"]]),ee={class:"main"},ne=y({__name:"index",setup(t){const i=A(),o=G(null);b();const u=a=>{m.emit("enter-screen",{to:a.id}),(()=>{var f,e,s;const{initCall:c,initLocal:d}=J(m,{userInfo:{id:(f=i.userInfo)==null?void 0:f.id,avatar:(e=i.userInfo)==null?void 0:e.avatar,nickname:(s=i.userInfo)==null?void 0:s.nickname},onRemoteTrack:l=>{console.log("onRemoteTrack"),o.value&&(o.value.srcObject=l)},onGetLocalStream:l=>{}});d(()=>{c(a.id,!0)})})()};return x(()=>{const a=()=>{var n,c,d;q(m,{userInfo:{id:(n=i.userInfo)==null?void 0:n.id,avatar:(c=i.userInfo)==null?void 0:c.avatar,nickname:(d=i.userInfo)==null?void 0:d.nickname},onRemoteTrack:f=>{},onGetLocalStream(f){}})};m.on("enter-screen",({sender:n,data:c})=>{a(),m.emit("enter-screen-answer",{to:n})})}),(a,n)=>(g(),B($,null,{nav:C(()=>[S(Z,{"click-item":u})]),main:C(()=>[p("div",ee,[p("video",{class:"screen-remote",src:"",ref_key:"videoRef",ref:o,autoplay:""},null,512)])]),_:1}))}});const te=I(ne,[["__scopeId","data-v-f651e793"]]);export{te as default};
