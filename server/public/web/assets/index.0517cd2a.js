import{d as g,a as v,b as w,u as D,o as y,aA as p,h as C,i as h,g as S,_ as x}from"./index.9e2263c7.js";function I(i,c,t){return navigator.mediaDevices.getDisplayMedia(i).then(c).catch(t)}function M(){return!!(navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}const R={iceServers:[{urls:["stun:ss-turn1.xirsys.com"]},{username:"CEqIDkX5f51sbm7-pXxJVXePoMk_WB7w2J5eu0Bd00YpiONHlLHrwSb7hRMDDrqGAAAAAF_OT9V0dWR1d2Vi",credential:"446118be-38a4-11eb-9ece-0242ac140004",urls:["turn:ss-turn1.xirsys.com:80?transport=udp","turn:ss-turn1.xirsys.com:3478?transport=udp"]}]};let d=null;const k=(i,c)=>{const{userInfo:t,onGetLocalStream:l,onRemoteTrack:o}=c;console.log("useCall userInfo",t);const n={};window.pc=n;function a(e,s){console.log("initCall",e,s);const f=new RTCPeerConnection(R);n[e]=f,d.getTracks().forEach(r=>{n[e].addTrack(r,d)});const m=async()=>{console.log("onnegotiationneeded");const r=await n[e].createOffer();console.log("setLocalDescription"),await n[e].setLocalDescription(r),console.log("send sdp"),i.emit("sdp",{type:"video-offer",description:n[e].localDescription,to:e,sender:t.id})};s&&(n[e].onnegotiationneeded=m),n[e].ontrack=r=>{let _=r.streams[0];o==null||o(_)},n[e].onicecandidate=({candidate:r})=>{console.log("onicecandidate"),i.emit("ice candidates",{candidate:r,to:e,sender:t.id})}}function u(e){if(d){l(d),e&&e();return}M()?I({video:!0},function(s){d=s,l(s),e&&e()},function(s){console.log("\u8BBF\u95EE\u7528\u6237\u5A92\u4F53\u8BBE\u5907\u5931\u8D25\uFF1A",s.name,s.message)}):alert("\u60A8\u7684\u6D4F\u89C8\u5668\u4E0D\u517C\u5BB9")}return i.on("ice candidates",e=>{if(console.log("ice candidate: ",e),console.log("pc[data.sender]",n[e.sender]),e.candidate){var s=new RTCIceCandidate(e.candidate);n[e.sender].addIceCandidate(s).catch()}}),i.on("sdp",e=>{console.log("receive sdp ",e),e.description.type==="offer"?u(()=>{a(e.sender,!1);let s=new RTCSessionDescription(e.description);n[e.sender].setRemoteDescription(s).then(()=>{n[e.sender].createAnswer().then(f=>n[e.sender].setLocalDescription(f)).then(()=>{i.emit("sdp",{type:"video-answer",description:n[e.sender].localDescription,to:e.sender,sender:t.id})}).catch()})}):e.description.type==="answer"&&n[e.sender].setRemoteDescription(new RTCSessionDescription(e.description))}),{initCall:a,initLocal:u,close:e=>{var s;(s=n[e])==null||s.close()}}},U={class:"main"},b=g({__name:"index",setup(i){const c=v(),t=w(null);D();const l=()=>{var o,n,a;k(p,{userInfo:{id:(o=c.userInfo)==null?void 0:o.id,avatar:(n=c.userInfo)==null?void 0:n.avatar,nickname:(a=c.userInfo)==null?void 0:a.nickname},onGetLocalStream(u){}})};return y(()=>{p.on("enter-screen",({sender:o,data:n})=>{l(),p.emit("enter-screen-answer",{to:o})})}),(o,n)=>(S(),C("div",U,[h("video",{class:"screen-remote",src:"",ref_key:"videoRef",ref:t,autoplay:""},null,512)]))}});const L=x(b,[["__scopeId","data-v-b87a6fbf"]]);export{L as default};
